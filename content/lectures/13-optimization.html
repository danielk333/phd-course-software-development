---
title: "Optimization"
description: ""
handout: optimization
weight: 13
---

<div class="reveal">
    <div class="slides">

        <section
            data-auto-animate
            data-background-image="media/c_python_funny.png"
            data-background-opacity="1"
        >
            <div class="centered-container"></div>
        </section>

        <section
            data-auto-animate
            data-background-image="media/c_python_funny.png"
            data-background-opacity="0.1"
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <p class="fragment">This topic is way too vast to cover in one lecture</p>
                <p class="fragment">So today we will cover:</p>
                <ul class="fragment">
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                </ul>
                <p class="mark">Donald Knuth 1974 - "Structured Programming With Go To Statements"</p>
                <blockquote class="fragment" cite="https://dl.acm.org/doi/abs/10.1145/356635.356640"
                style="width: 75vw;">
                    We should forget about small efficiencies, say about 97% of the time:
                    <span class="highlight">premature optimization is the root of all evil.</span>Yet we should not pass up
                    our opportunities in that critical 3%.
                </blockquote>
                <p class="fragment">Takeaway?</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                </ul>
                <p class="select">Takeaway?</p>
                <ul class="list-sep-small">
                    <li>Optimize when you ACTUALLY need to</li>
                    <li class="fragment">Then optimize the important parts <br> - use profiling, don't
                        guess!</li>
                    <li class="fragment">Highly optimized code: usually harder to read and slower to write</li>
                    <li class="fragment">Instead learn to write performant enough code by default<br> - not fully optimized
                        code</li>
                    <li class="fragment">But write your code to allow for future optimization <br> - don't
                        paint yourself into a corner</li>
                </ul>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p class="mark fragment">CPU data access</p>
                <img src="media/computer_arch.png" class="fragment" style="height:
                50vh;">
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <img src="media/computer_arch.png" class="fragment" style="height:
                80vh;">
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <ul>
                    <p class="mark">Typical Intel Xeon</p>
                    <li>L1 cache - Up to 80 KB per core</li>
                    <li>L2 cache - Up to 2 MB per core</li>
                    <li>L3 cache - Up to 320 MB per socket</li>
                </ul>
                <p class="fragment">Example:</p>
            </div>
        </section>
        
        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>Example:</p>
                <ol>
                    <li>CPU needs data</li>
                    <li>looks in L1</li>
                    <li>does not find</li>
                    <li>looks in L2</li>
                    <li>finds data</li>
                    <li>loads data from L2 to L1</li>
                    <li>CPU uses data</li>
                </ol>
                <p class="fragment select">This is what is called a "cache miss"!</p>
                <p class="fragment highlight">So how do you choose what goes to which cache?</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p class="highlight">So how do you choose what goes to which cache?</p>
                <p>Well, you don't, the CPU/Motherboard does</p>
                <p class="fragment">But you can help it along - contiguous memory and frequent use!</p>
                <p class="fragment highlight">For more info - see videos in handout!</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p class="highlight">Also - the same way memory usage is "predicted"</p>
                <p class="fragment">so are code "branches"!</p>
                <p class="fragment mark">(for more, see video in handout!)</p>
                <p class="fragment">For example</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>For example</p>
                <pre data-id="code-animation" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-c">
                        #include &lt;stdio.h&gt;
                        #include &lt;stdlib.h&gt;

                        #define SIZE 1000000

                        int main() {
                            int *arr = malloc(SIZE * sizeof(int));
                            if (!arr) return 1;
                            srand(1234);
                            for (int i = 0; i &lt; SIZE; ++i) {
                                arr[i] = rand() % 100;
                            }

                            int count = 0;
                            for (int i = 0; i &lt; SIZE; ++i) {
                                if (arr[i] &gt; 50) { // unpredictable branch
                                    count++;
                                }
                            }

                            printf("Count: %d\n", count);
                            free(arr);
                            return 0;
                        }
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>For example</p>
                <pre data-id="code-animation" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-c">
                        #include &lt;stdio.h&gt;
                        #include &lt;stdlib.h&gt;

                        #define SIZE 1000000

                        int main() {
                            int *arr = malloc(SIZE * sizeof(int));
                            if (!arr) return 1;
                            srand(1234);
                            for (int i = 0; i &lt; SIZE; ++i) {
                                arr[i] = rand() % 100;
                            }

                            int count = 0;
                            for (int i = 0; i &lt; SIZE; ++i) {
                                count += (arr[i] > 50);  // no actual branch
                            }

                            printf("Count: %d\n", count);
                            free(arr);
                            return 0;
                        }
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>For example</p>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ hyperfine -N ./branch_miss.o
                        Benchmark 1: ./branch_miss.o
                          Time (mean ± σ):      20.1 ms ±   1.1 ms    [User: 19.0 ms, System: 0.8 ms]
                          Range (min … max):    19.0 ms …  28.4 ms    143 runs
                         
                        $ hyperfine -N ./no_branch_miss.o
                        Benchmark 1: ./no_branch_miss.o
                          Time (mean ± σ):      15.5 ms ±   0.8 ms    [User: 14.5 ms, System: 0.8 ms]
                          Range (min … max):    14.7 ms …  23.3 ms    190 runs
                    </code>
                </pre>
                <p class="fragment mark">1.3 speedup just from that!</p>
                <p class="fragment">Why? Lets try <code>perf stat</code></p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>Why? Lets try <code>perf stat</code></p>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                    $ perf stat ./branch_miss.o
                    Count: 489858

                     Performance counter stats for './branch_miss.o':

                                 19,08 msec task-clock:u                     #    0,982 CPUs utilized             
                                     0      context-switches:u               #    0,000 /sec                      
                                     0      cpu-migrations:u                 #    0,000 /sec                      
                                   527      page-faults:u                    #   27,627 K/sec                     
                            89 598 854      instructions:u                   #    1,08  insn per cycle            
                            83 305 829      cycles:u                         #    4,367 GHz                       
                            18 029 879      branches:u                       #  945,179 M/sec                     
                               537 691      branch-misses:u                  #    2,98% of all branches           

                           0,019415949 seconds time elapsed

                           0,019496000 seconds user
                           0,000000000 seconds sys
                    </code>
                </pre>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <p>Why? Lets try <code>perf stat</code></p>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                    $  perf stat ./no_branch_miss.o 
                    Count: 489858

                     Performance counter stats for './no_branch_miss.o':

                                 15,18 msec task-clock:u                     #    0,979 CPUs utilized             
                                     0      context-switches:u               #    0,000 /sec                      
                                     0      cpu-migrations:u                 #    0,000 /sec                      
                                   527      page-faults:u                    #   34,717 K/sec                     
                            91 108 993      instructions:u                   #    1,40  insn per cycle            
                            64 947 318      cycles:u                         #    4,279 GHz                       
                            17 029 876      branches:u                       #    1,122 G/sec                     
                                34 884      branch-misses:u                  #    0,20% of all branches           

                           0,015498122 seconds time elapsed

                           0,015587000 seconds user
                           0,000000000 seconds sys
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Computer architecture</li>
                </ul>
                <ul>
                    <p class="mark">Takeaways</p>
                    <li>If you can load working data into RAM - do it</li>
                    <li class="fragment">Work with the CPU optimizer rather than against it</li>
                    <ul class="fragment">
                        <li>Use contiguous memory</li>
                        <li>Process data all at once</li>
                        <li>Try to not have the CPU wait for work</li>
                        <li>Avoid branching</li>
                        <li>...</li>
                    </ul>
                    <li class="fragment">We don't have time to cover GPU now - links in handout</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <p class="fragment mark">Data vectorization</p>
                <p class="fragment">An example: Mandelbrot set calculation</p>
                <div class="fragment">
                    $$
                    z_{n+1} = z_n + c
                    $$
                    $$
                    z_0 = 0,\; z_n \in \mathbb{C},\; z_n \mapsto \infty?
                    $$
                </div>
                <img src="media/mandelbrot.png" class="fragment light" style="height: 20vh;">
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <img src="media/mandelbrot.png" class="light" style="height: 65vh;">
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre data-id="code-animation" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-python" style="height: 60vh;">
                        import time
                        import numpy as np


                        def iter_fun(zn, C):
                            return zn**2 + C


                        def iter_n_loop(z0, C, max_num, limit):
                            z = z0 * np.ones(C.shape, dtype=C.dtype)

                            mat_shape = z.shape
                            mat_size = z.size

                            # we only iterate until the limit is passed, then it is considered divergant
                            # use the "iters" as a indication of this
                            iters = np.zeros((mat_size,), dtype=np.int32)

                            # flatten for only one loop
                            z.shape = (mat_size,)
                            C.shape = (mat_size,)

                            for it in range(mat_size):
                                for ind in range(max_num):
                                    z[it] = iter_fun(z[it], C[it])

                                    if z[it] * np.conj(z[it]) &gt; limit**2:
                                        iters[it] = ind
                                        break

                            # all iterations that survived without passing limit went trough the entire loop
                            iters[iters == 0] = max_num

                            # change shape back to original
                            z.shape = mat_shape
                            C.shape = mat_shape
                            iters.shape = mat_shape
                            return z, iters


                        def iter_n_vec(z0, C, max_num, limit):
                            z = z0 * np.ones(C.shape, dtype=C.dtype)

                            # we only iterate until the limit is passed, then it is considered divergant
                            # use the "iters" as a indication of this
                            iters = np.zeros(C.shape, dtype=np.int32)
                            for ind in range(max_num):
                                z[iters == 0] = iter_fun(z[iters == 0], C[iters == 0])

                                # if the norm of z passes the limit, stop iteration by setting the value to the iteration integer
                                z_norm = z * np.conj(z)
                                z_norm_check = np.logical_and(z_norm &gt; limit**2, iters == 0)
                                iters[z_norm_check] = ind

                            # all iterations that survived so far went trough the entire loop
                            iters[iters == 0] = max_num
                            return z, iters


                        def mandelbrot_set(C_mat, max_num, limit, iter_fun):
                            z0 = 0.0 + 0.0j
                            Z, iters = iter_fun(z0, C_mat, max_num=max_num, limit=limit)
                            Z_norm = np.real(np.sqrt(Z * np.conj(Z)))
                            return Z_norm, iters


                        if __name__ == "__main__":
                            n_base = 300

                            xmin, xmax, xn = -0.45, -0.42, n_base
                            ymin, ymax, yn = -0.59, -0.55, n_base
                            xv = np.linspace(xmin, xmax, xn, dtype=np.float32)
                            yv = np.linspace(ymin, ymax, yn, dtype=np.float32)
                            X, Y = np.meshgrid(xv, yv)

                            max_num = 120
                            limit = 4.0

                            t0 = time.time()
                            Z_norm, iters = mandelbrot_set(
                                C_mat=X + Y * 1.0j, max_num=max_num, limit=limit, iter_fun=iter_n_loop
                            )
                            dtl = time.time() - t0
                            print(f"loop execution time {dtl} sec")

                            t0 = time.time()
                            Z_norm, iters = mandelbrot_set(
                                C_mat=X + Y * 1.0j, max_num=max_num, limit=limit, iter_fun=iter_n_vec
                            )
                            dtv = time.time() - t0
                            print(f"vectorized execution time {dtv} sec")
                            print(f"speedup {dtl/dtv}")
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre data-id="code-animation" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-python" style="height: 60vh;">
                        def iter_n_loop(z0, C, max_num, limit):
                            z = z0 * np.ones(C.shape, dtype=C.dtype)

                            mat_shape = z.shape
                            mat_size = z.size

                            # we only iterate until the limit is passed, then it is considered divergant
                            # use the "iters" as a indication of this
                            iters = np.zeros((mat_size,), dtype=np.int32)

                            # flatten for only one loop
                            z.shape = (mat_size,)
                            C.shape = (mat_size,)

                            for it in range(mat_size):
                                for ind in range(max_num):
                                    z[it] = iter_fun(z[it], C[it])

                                    if z[it] * np.conj(z[it]) &gt; limit**2:
                                        iters[it] = ind
                                        break

                            # all iterations that survived without passing limit went trough the entire loop
                            iters[iters == 0] = max_num

                            # change shape back to original
                            z.shape = mat_shape
                            C.shape = mat_shape
                            iters.shape = mat_shape
                            return z, iters
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre data-id="code-animation" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-python" style="height: 60vh;">
                        def iter_n_vec(z0, C, max_num, limit):
                            z = z0 * np.ones(C.shape, dtype=C.dtype)

                            # we only iterate until the limit is passed, then it is considered divergant
                            # use the "iters" as a indication of this
                            iters = np.zeros(C.shape, dtype=np.int32)
                            for ind in range(max_num):
                                z[iters == 0] = iter_fun(z[iters == 0], C[iters == 0])

                                # if the norm of z passes the limit, stop iteration by setting the value to the iteration integer
                                z_norm = z * np.conj(z)
                                z_norm_check = np.logical_and(z_norm &gt; limit**2, iters == 0)
                                iters[z_norm_check] = ind

                            # all iterations that survived so far went trough the entire loop
                            iters[iters == 0] = max_num
                            return z, iters
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-python" style="height: 30vh;">
                        def iter_n_vec(z0, C, max_num, limit):
                            z = z0 * np.ones(C.shape, dtype=C.dtype)

                            # we only iterate until the limit is passed, then it is considered divergant
                            # use the "iters" as a indication of this
                            iters = np.zeros(C.shape, dtype=np.int32)
                            for ind in range(max_num):
                                z[iters == 0] = iter_fun(z[iters == 0], C[iters == 0])

                                # if the norm of z passes the limit, stop iteration by setting the value to the iteration integer
                                z_norm = z * np.conj(z)
                                z_norm_check = np.logical_and(z_norm &gt; limit**2, iters == 0)
                                iters[z_norm_check] = ind

                            # all iterations that survived so far went trough the entire loop
                            iters[iters == 0] = max_num
                            return z, iters
                    </code>
                </pre>
                <pre class="fragment show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ python vectorization.py
                        loop execution time 6.237718343734741 sec
                        vectorized execution time 0.07863926887512207 sec
                        speedup 79.3206553540082
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <p class="mark">What about the second vectorization?</p>
                <p class="fragment">Single instruction, multiple data (SIMD)!</p>
                <p class="fragment">Usually these are done for you!</p>
                <ul class="fragment">
                    <li><code>numpy</code> automatically uses simd</li>
                    <li><code>-O3</code> and <code>-march</code> in <code>gcc</code> also does it</li>
                    <li>...</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <p>Usually these are done for you!</p>
                <p class="highlight">Anyway here is an example!</p>
                <pre class="fragment show-code">
                    <code data-line-numbers data-trim class="language-c" style="height: 50vh;">
                        void add_float_arrays(float* a, float* b, float* result, int size) {
                            for (int i = 0; i &lt; size; ++i) {
                                result[i] = a[i] + b[i];
                            }
                        }

                        int main() {
                            int size = 100000;
                            int steps = 1000;
                            float x[size], y[size], res[size];

                            for (int i = 0; i &lt; size; i++) {
                                x[i] = (float)i;
                                y[i] = x[i] + 1;
                            }

                            add_float_arrays(x, y, res, size);
                            for (int i = 0; i &lt; steps; i++) {
                                add_float_arrays(res, y, res, size);
                            }
                            return 0;
                        }
                    </code>
                </pre>

            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-c" style="height: 65vh;">
                        void add_float_arrays(float* a, float* b, float* result, int size) {
                            for (int i = 0; i &lt; size; ++i) {
                                result[i] = a[i] + b[i];
                            }
                        }

                        int main() {
                            int size = 100000;
                            int steps = 1000;
                            float x[size], y[size], res[size];

                            for (int i = 0; i &lt; size; i++) {
                                x[i] = (float)i;
                                y[i] = x[i] + 1;
                            }

                            add_float_arrays(x, y, res, size);
                            for (int i = 0; i &lt; steps; i++) {
                                add_float_arrays(res, y, res, size);
                            }
                            return 0;
                        }
                    </code>
                </pre>

            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-c" style="height: 65vh;">
                        #include &lt;stdio.h&gt;
                        #include &lt;immintrin.h&gt;

                        void add_float_arrays_avx512(const float* a, const float* b, float* result, int size) {
                            int i;
                            for (i = 0; i &lt;= size - 16; i += 16) {
                                __m512 va = _mm512_loadu_ps(&a[i]);
                                __m512 vb = _mm512_loadu_ps(&b[i]);
                                __m512 vsum = _mm512_add_ps(va, vb);
                                _mm512_storeu_ps(&result[i], vsum);
                            }
                            for (; i &lt; size; ++i) {
                                result[i] = a[i] + b[i];
                            }
                        }

                        int main() {
                            int size = 100000;
                            int steps = 1000;
                            float x[size], y[size], res[size];

                            for (int i = 0; i &lt; size; i++) {
                                x[i] = (float)i;
                                y[i] = x[i] + 1;
                            }

                            add_float_arrays_avx512(x, y, res, size);
                            for (int i = 0; i &lt; steps; i++) {
                                add_float_arrays_avx512(res, y, res, size);
                            }
                            return 0;
                        }
                    </code>
                </pre>

            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Vectorization vs Vectorization</li>
                </ul>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ hyperfine -N ./without_simd.o 
                        Benchmark 1: ./without_simd.o
                          Time (mean ± σ):     120.5 ms ±   1.7 ms    [User: 118.8 ms, System: 1.0 ms]
                          Range (min … max):   118.3 ms … 124.2 ms    24 runs
                         
                        $ hyperfine -N ./with_simd.o 
                        Benchmark 1: ./with_simd.o
                          Time (mean ± σ):      36.6 ms ±   2.4 ms    [User: 35.2 ms, System: 1.1 ms]
                          Range (min … max):    33.1 ms …  43.9 ms    78 runs
                    </code>
                </pre>
                <p class="fragment mark">But this is not fair, lets have a look at compiler
                    optimization</p>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Compiled languages and automatic optimizers</li>
                </ul>
                <p class="mark">So there is a reason most examples today are in C</p>
                <ul class="fragment list-sep-small">
                    <li>Usually you need to go to a "low-level" compiled language to optimize</li>
                    <li>Full control over memory and CPU instructions</li>
                    <li>When the language is compiled - automatic optimization is easier!</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Compiled languages and automatic optimizers</li>
                </ul>
                <p>last example: lets try <code>-O3</code></p>
                <pre class="fragment show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ hyperfine -N ./without_simd_o3.o 
                        Benchmark 1: ./without_simd_o3.o
                          Time (mean ± σ):     498.4 µs ± 107.0 µs    [User: 266.8 µs, System: 183.2 µs]
                          Range (min … max):   236.5 µs … 2306.9 µs    2866 runs
                         
                        $ hyperfine -N ./with_simd_o3.o
                        Benchmark 1: ./with_simd_o3.o
                          Time (mean ± σ):     499.1 µs ±  91.7 µs    [User: 267.6 µs, System: 181.9 µs]
                          Range (min … max):   239.2 µs … 1698.2 µs    3592 runs
                    </code>
                </pre>
                <p class="fragment mark">So usually you do not need to hand-roll these, only in
                    extreme scenarios</p>
                <p class="fragment">But now you know it exists and is a thing!</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Compiled languages and automatic optimizers</li>
                </ul>
                <p>Throughout the lecture today - compiled with and without <code>-O</code></p>
                <p class="fragment">and more detail at the end</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Shaving operations</li>
                </ul>
                <p class="highlight">This is a quick one:</p>
                <ul>
                    <li class="fragment">Some operations take many cycles</li>
                    <li class="fragment">Some operations can be skipped</li>
                    <li class="fragment">Some operations can be exchanged to faster ones</li>
                </ul>
                <p class="fragment mark">An example!</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre data-id="code-animation1" class="fragment show-code">
                    <code data-line-numbers data-trim class="language-c" style="height: 65vh;">
                        #include &lt;stdio.h&gt;
                        #include &lt;math.h&gt;

                        int main() {
                            int size = 10000;
                            double x[size], y[size];

                            FILE *file = fopen("data.csv", "r");
                            double value;
                            int count;
                            while (!feof(file)) {
                                if (fscanf(file, "%lf,", &value) == 1) {
                                    if (count &lt; size) {
                                        x[count] = value;
                                    }
                                    else {
                                        y[count - size] = value;
                                    }
                                    count++;
                                }
                            }
                            fclose(file);

                            double r;
                            double dx, dy;
                            int total;
                            for(int i = 0; i &lt; size; i++) {
                                for(int j = 0; j &lt; size; j++) {
                                    dx = x[i] - x[j];
                                    dy = y[i] - y[j];
                                    r = sqrt(dx*dx + dy*dy);
                                    if (r &lt; 1.0) {
                                        total++;
                                    }
                                }
                            }

                            printf("Prob %f\n", ((float)total)/(size*size));
                            return 0;
                        }
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre data-id="code-animation1" class="show-code">
                    <code data-line-numbers data-trim class="language-c" style="height: 65vh;">
                        #include &lt;stdio.h&gt;
                        #include &lt;math.h&gt;

                        int main() {
                            //  load data... 
                            double r;
                            double dx, dy;
                            int total;
                            for(int i = 0; i &lt; size; i++) {
                                for(int j = 0; j &lt; size; j++) {
                                    dx = x[i] - x[j];
                                    dy = y[i] - y[j];
                                    r = sqrt(dx*dx + dy*dy);
                                    if (r &lt; 1.0) {
                                        total++;
                                    }
                                }
                            }

                            printf("Prob %f\n", ((float)total)/(size*size));
                            return 0;
                        }
                    </code>
                </pre>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-c">
                        #include &lt;stdio.h&gt;
                        #include &lt;math.h&gt;
                        #include "data.h"

                        int main() {
                            //  load data... 
                            double r;
                            int total;
                            for(int i = 0; i &lt; size; i++) {
                                for(int j = 0; j &lt; size; j++) {
                                    r = (x[i] - x[j])*(x[i] - x[j]) + (y[i] - y[j])*(y[i] - y[j]);
                                    if (r &lt; 1.0) {
                                        total++;
                                    }
                                }
                            }

                            printf("Prob %f\n", ((float)total)/(size*size));
                            return 0;
                        }
                    </code>
                </pre>
            </div>
        </section>


        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Shaving operations</li>
                </ul>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ hyperfine ./shaving_op_with_o0.o -N -r 5
                        Benchmark 1: ./shaving_op_with_o0.o
                          Time (mean ± σ):     889.1 ms ±   3.4 ms    [User: 883.9 ms, System: 0.6 ms]
                          Range (min … max):   886.3 ms … 894.0 ms    5 runs
                         
                        $ hyperfine ./shaving_op_without_o0.o -N -r 5
                        Benchmark 1: ./shaving_op_without_o0.o
                          Time (mean ± σ):     591.2 ms ±   3.3 ms    [User: 587.3 ms, System: 1.0 ms]
                          Range (min … max):   587.8 ms … 596.2 ms    5 runs
                    </code>
                </pre>
                <p class="fragment">1.5 speedup!</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Shaving operations</li>
                </ul>
                <pre class="fragment show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        $ hyperfine -N ./shaving_op_with_o3.o
                        Benchmark 1: ./shaving_op_with_o3.o
                          Time (mean ± σ):      96.4 ms ±   1.4 ms    [User: 94.6 ms, System: 0.9 ms]
                          Range (min … max):    93.7 ms …  99.9 ms    30 runs
                         
                        $ hyperfine -N ./shaving_op_without_o3.o
                        Benchmark 1: ./shaving_op_without_o3.o
                          Time (mean ± σ):      27.7 ms ±   1.1 ms    [User: 26.7 ms, System: 0.7 ms]
                          Range (min … max):    26.2 ms …  30.9 ms    98 runs
                    </code>
                </pre>
                <p class="fragment">21.3 speedup from <code>-O3</code> and 3.48 vs with <code>sqrt</code>!</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Algorithms and data representation</li>
                </ul>
                <ul>
                    <li class="fragment">Are you noticing almost all time is spend in one algorithm?</li>
                    <li class="fragment">Have a look if that one is optimal - maybe there are faster
                    ones!</li>
                </ul>
                <p class="fragment">Example: <a href="https://www.youtube.com/watch?v=kPRA0W1kECg">15 Sorting Algorithms in 6 Minutes</a></p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Algorithms and data representation</li>
                </ul>
                <p class="fragment highlight">Data representation we already covered a bit</p>
                <p class="fragment">As a recap example:</p>
                <p class="fragment">Algorithms on a chess board - board representation?</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Algorithms and data representation</li>
                </ul>
                <p>Algorithms on a chess board - board representation?</p>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-python">
                        class Board:
                            pieces: list[PlacedPiece]

                        class PlacedPiece:
                            kind: Piece
                            position: tuple[int, int]

                        class Piece(Enum):
                            rook = 1
                        ...
                    </code>
                </pre>
                <p class="fragment">VS.</p>
                <pre class="fragment show-code">
                    <code data-line-numbers data-trim class="language-c">
                        uint64_t board[N_PIECES];
                    </code>
                </pre>
                <p class="fragment">How?</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Algorithms and data representation</li>
                </ul>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-c">
                        uint64_t board[N_PIECES];
                    </code>
                </pre>
                <p>How?</p>
                <pre class="show-code">
                    <code data-line-numbers data-trim class="language-plaintext">
                        0 0 1 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                        0 0 0 0 0 0 0 0
                    </code>
                </pre>
                <p class="fragment"><code>= 1152921504606846976</code></p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Approximations</li>
                </ul>
                <p>This you already know:</p>
                <ul class="fragment">
                    <li>Find out the accuracy you need</li>
                    <li>Can you use an approximation that's faster and sufficient?</li>
                </ul>
                <p class="fragment mark">For example:</p>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Approximations</li>
                </ul>
                <p class="mark">For example:</p>
                $$
                Ei(x) = \int_{-x}^{\infty} \frac{e^{-t}}{t} \mathrm{d}t
                $$
                <p>VS.</p>
                $$
                Ei(x) \approx -(A^{-7.7} + B)^{-0.13} \\
                A = \ln \left ( \left ( \frac{0.56146}{-x} + 0.65 \right )( 1 - x) \right ) \\
                B = (-x)^4 e^{-7.7x} (2 - x)^{3.7}
                $$
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>When to optimize</li>
                    <li>Computer architecture</li>
                    <li>Vectorization vs Vectorization</li>
                    <li>Compiled languages and automatic optimizers</li>
                    <li>Shaving operations</li>
                    <li>Algorithms and data representation</li>
                    <li>Approximations</li>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
            </div>
        </section>

        <section
            data-auto-animate
        >
            <div class="centered-container">
                <h3 class="title">Optimization</h3>
                <ul>
                    <li>Digging deep (compiled assembly)</li>
                </ul>
                <p class="fragment select">Again - do not optimize prematurely - but write performant code</p>
                <p class="fragment">To optimize you usually need to try A LOT of approaches</p>
                <p class="fragment">For digging deep, there is really only one recommendation I have:</p>
                <p class="fragment"><a href="https://godbolt.org/">https://godbolt.org/</a> - let's
                    have a look</p>
            </div>
        </section>



    </div>
</div>

